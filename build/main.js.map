{"version":3,"file":"main.js","sourceRoot":"/","sources":["main.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAMA,+BAAiC;AAEjC,yBAAyB;AACzB,MAAM,QAAQ,GAAG,IAAA,gBAAS,EAAC,EAAE,CAAC,QAAQ,CAAC,CAAC;AACxC,MAAM,OAAO,GAAG,IAAA,gBAAS,EAAC,EAAE,CAAC,OAAO,CAAC,CAAC;AAEtC,iCAAiC;AAEjC,gDAAgD;AAEhD,qDAA2C;AAE3C,qCAAkC;AAElC,mDAAqD;AAkBrD,MAAa,cAAe,SAAQ,KAAK,CAAC,OAAO;IAgB/C,YAAmB,UAAyC,EAAE;QAC5D,KAAK,iCACA,OAAO,KACV,IAAI,EAAE,SAAS,IACf,CAAC;QAfG,YAAO,GAA2B,EAAE,CAAC;QAKtC,uBAAkB,GAA8B,IAAI,CAAC;QAY1D,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;QAC/B,IAAI,CAAC,EAAE,CAAC,aAAa,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;QAC3C,IAAI,CAAC,EAAE,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QACnC,IAAI,CAAC,EAAE,CAAC,QAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;IACnC,CAAC;IAMa,OAAO;;YAEnB,IAAI,CAAC,QAAQ,CAAC,iBAAiB,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;YAG9C,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE;gBAC9B,IAAI,CAAC,MAAM,CAAC,aAAa,GAAG,qBAAqB,CAAC;aACnD;YAGD,IAAI,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE;gBAE7B,IAAI,IAAI,CAAC,eAAe,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC,6BAA6B,CAAC,EAAE;oBAChF,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,uOAAuO,CAAC,CAAC;iBACxP;gBAGD,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,UAAU,IAAI,IAAI,CAAC,MAAM,CAAC,UAAU,IAAI,CAAC,EAAE;oBAC1D,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,6EAA6E,CAAC,CAAC;oBAC7F,IAAI,CAAC,MAAM,CAAC,UAAU,GAAG,IAAI,CAAC;iBAC/B;gBAGD,IAAI,OAAO,IAAI,CAAC,MAAM,CAAC,SAAS,KAAK,QAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,MAAM,KAAK,EAAE,EAAE;oBACpF,IAAI,CAAC,MAAM,CAAC,SAAS,GAAG,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;oBAC/D,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,uEAAuE,IAAI,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC,CAAC;iBAClH;gBAED,IAAI,CAAC,kBAAkB,GAAG,IAAI,kCAAkB,CAAC,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;gBAEtG,IAAI,CAAC,kBAAkB,CAAC,EAAE,CAAC,WAAW,EAAE,GAAG,EAAE;oBAC3C,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,6CAA6C,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC,CAAC;oBACrF,IAAI,CAAC,oBAAoB,EAAE,CAAC;gBAC9B,CAAC,CAAC,CAAC;gBAEH,IAAI,CAAC,kBAAkB,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,GAAU,EAAE,EAAE;oBACjD,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,+BAA+B,GAAG,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;oBAC/D,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,GAAG,CAAC,QAAQ,EAAE,IAAI,GAAG,CAAC,KAAK,EAAE,CAAC,CAAC;oBACjD,IAAI,CAAC,oBAAoB,EAAE,CAAC;gBAC9B,CAAC,CAAC,CAAC;aACJ;YAGD,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,SAAS,GAAG,YAAY,EAAE,OAAO,EAAE,CAAC,GAAG,EAAE,OAAO,EAAE,EAAE;gBAC9E,IAAI,GAAG,EAAE;oBACP,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,oCAAoC,CAAC,CAAC;oBACrD,OAAO;iBACR;gBAED,KAAK,MAAM,QAAQ,IAAI,OAAO,EAAE;oBAC9B,MAAM,GAAG,GAAiB,OAAO,CAAC,QAAQ,CAAiB,CAAC;oBAE5D,IAAI,OAAO,GAAG,CAAC,MAAM,CAAC,OAAO,KAAK,QAAQ,EAAE;wBAC1C,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,GAAG,CAAC,GAAG,wBAAwB,CAAC,CAAC;wBACzD,SAAS;qBACV;oBAED,IAAI,GAAG,CAAC,MAAM,CAAC,OAAO,KAAK,KAAK,EAAE;wBAChC,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,GAAG,CAAC,MAAM,CAAC,OAAO,sCAAsC,CAAC,CAAC;wBACnF,SAAS;qBACV;oBAED,IAAI,GAAG,CAAC,MAAM,CAAC,cAAc,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE;wBAC3D,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,GAAG,CAAC,MAAM,CAAC,OAAO,sCAAsC,GAAG,CAAC,MAAM,CAAC,cAAc,sCAAsC,CAAC,CAAC;wBACjJ,SAAS;qBACV;oBAED,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,IAAI,eAAM,CAAC;wBACjC,aAAa,EAAE,IAAI,CAAC,MAAM,CAAC,aAAa;wBACxC,EAAE,EAAE,GAAG,CAAC,GAAG;wBACX,OAAO,EAAE,GAAG,CAAC,MAAM,CAAC,OAAO;wBAC3B,QAAQ,EAAE,OAAO,GAAG,CAAC,MAAM,CAAC,QAAQ,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,eAAe;wBACrG,WAAW,EAAE,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,WAAW;wBACrC,MAAM,EAAE,OAAO,GAAG,CAAC,MAAM,CAAC,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;wBACrE,MAAM,EAAE,OAAO,GAAG,CAAC,MAAM,CAAC,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;wBACrE,QAAQ,EAAE,OAAO,GAAG,CAAC,MAAM,CAAC,QAAQ,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI;wBAC9E,cAAc,EAAE,OAAO,GAAG,CAAC,MAAM,CAAC,cAAc,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,cAAc,CAAC,CAAC,CAAC,IAAI;qBACjG,EAAE,IAAI,CAAC,CAAC;oBACT,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,OAAO,EAAE,IAAI,CAAC,iBAAiB,CAAC,CAAC;oBAC1D,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,OAAO,EAAE,IAAI,CAAC,iBAAiB,CAAC,CAAC;oBAC1D,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,mBAAmB,EAAE,IAAI,CAAC,6BAA6B,CAAC,CAAC;iBACnF;gBAED,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,UAAU,CAAC,CAAC;YACvE,CAAC,CAAC,CAAC;YAGH,IAAI,CAAC,eAAe,CAAC,WAAW,CAAC,CAAC;QACpC,CAAC;KAAA;IAMa,QAAQ,CAAC,QAAoB;;YACzC,IAAI;gBAEF,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,OAAO,EAAE;oBAClC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,CAAC;iBAC9B;gBAGD,IAAI,IAAI,CAAC,kBAAkB,EAAE;oBAC3B,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE,CAAC;iBACtC;gBAGD,MAAM,IAAI,CAAC,aAAa,CAAC,iBAAiB,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;aAE1D;YAAC,OAAM,CAAC,EAAE,GAAG;YAEd,QAAQ,EAAE,CAAC;QACb,CAAC;KAAA;IAQO,iBAAiB,CAAE,KAAoB,EAAE,EAAU;QACzD,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;YAAE,OAAO;QAE9B,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,aAAa,KAAK,gBAAgB,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC;QAE7E,IAAI,KAAK,KAAK,IAAI,EAAE;YAClB,IAAI,CAAC,aAAa,CAAC,EAAE,EAAE;gBACrB,GAAG,EAAE,IAAI;gBACT,GAAG,EAAE,IAAI;gBACT,CAAC,EAAE,IAAI;aACR,CAAC,CAAC;SACJ;aAAM;YACL,IAAI,CAAC,aAAa,CAAC,EAAE,EAAE;gBACrB,GAAG,EAAE,IAAI;gBACT,GAAG,EAAE,KAAK;aACX,CAAC,CAAC;SACJ;IACH,CAAC;IAQO,iBAAiB,CAAE,GAAU,EAAE,EAAU;QAC/C,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,wBAAwB,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,OAAO,KAAK,GAAG,EAAE,CAAC,CAAC;IAC5E,CAAC;IAUO,6BAA6B,CAAE,QAAiB,EAAE,EAAU;QAClE,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,yBAAyB,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,OAAO,eAAe,QAAQ,EAAE,CAAC,CAAC;QAE3F,IAAI,CAAC,oBAAoB,EAAE,CAAC;IAC9B,CAAC;IAMO,oBAAoB;QAE1B,IAAI,IAAI,CAAC,kBAAkB,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,WAAW,EAAE,EAAE;YAErE,IAAI,CAAC,aAAa,CAAC,iBAAiB,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;YACnD,OAAO;SACR;QAGD,KAAK,MAAM,EAAE,IAAI,IAAI,CAAC,OAAO,EAAE;YAC7B,IAAI,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,QAAQ,EAAE;gBAE7B,IAAI,CAAC,aAAa,CAAC,iBAAiB,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;gBACnD,OAAO;aACR;SACF;QAGD,IAAI,CAAC,aAAa,CAAC,iBAAiB,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;IACpD,CAAC;IAOM,SAAS,CAAE,WAAmB;QACnC,IAAI,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC;YAAE,OAAO,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;QAGhE,KAAK,MAAM,EAAE,IAAI,IAAI,CAAC,OAAO,EAAE;YAC7B,IAAI,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,OAAO,KAAK,WAAW,EAAE;gBAC5C,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;aACzB;SACF;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAMO,OAAO,CAAE,WAAoB;QACnC,IAAI,OAAO,WAAW,KAAK,QAAQ,IAAI,WAAW,KAAK,KAAK,IAAI,WAAW,KAAK,EAAE,EAAE;YAElF,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,gCAAgC,CAAC,CAAC;YAChD,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,OAAO,EAAE;gBAC/B,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,CAAC;aAC3B;SAEF;aAAM;YAEL,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC;YAEzC,IAAI,CAAC,IAAI,EAAE;gBACT,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,gCAAgC,WAAW,SAAS,CAAC,CAAC;gBACpE,OAAO;aACR;YAED,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,yBAAyB,IAAI,CAAC,OAAO,MAAM,CAAC,CAAC;YAC3D,IAAI,CAAC,IAAI,EAAE,CAAC;SACb;IACH,CAAC;IAQa,aAAa,CAAC,EAAU,EAAE,KAAwC;;YAC9E,IAAI,KAAK,EAAE;gBAET,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,EAAE,aAAa,KAAK,CAAC,GAAG,WAAW,KAAK,CAAC,GAAG,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC;gBAGlG,IAAI,KAAK,CAAC,GAAG,KAAK,IAAI;oBAAE,OAAO;gBAG/B,QAAQ,EAAE,EAAE;oBACV,KAAK,IAAI,CAAC,SAAS,GAAG,kBAAkB;wBACtC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,GAAa,CAAC,CAAC;wBAClC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,SAAS,GAAG,kBAAkB,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC;wBAClE,MAAM;iBACT;aAEF;iBAAM;gBAEL,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC;aACvC;QACH,CAAC;KAAA;IAOa,SAAS,CAAC,GAAqB;;YAC3C,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,cAAc,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;YAErD,IAAI,OAAO,GAAG,KAAK,QAAQ,IAAI,GAAG,CAAC,OAAO,EAAE;gBAC1C,QAAQ,GAAG,CAAC,OAAO,EAAE;oBACnB,KAAK,SAAS;wBAEZ,IAAI,OAAO,GAAG,CAAC,OAAO,KAAK,QAAQ,EAAE;4BACnC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;yBAC3B;6BAAM;4BACL,IAAI,CAAC,OAAO,EAAE,CAAC;yBAChB;wBACD,MAAM;oBAER,KAAK,MAAM;wBAET,IAAI,OAAO,GAAG,CAAC,OAAO,KAAK,QAAQ,EAAE;4BACnC,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;4BACzC,IAAI,CAAC,IAAI,EAAE;gCACT,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,gBAAgB,CAAC,CAAC;gCACjC,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,OAAO,EAAE,EAAE,GAAG,EAAE,gBAAgB,EAAG,KAAK,EAAE,IAAI,EAAE,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;6BAClG;4BACD,IAAI,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,KAAK,EAAE,EAAE;gCACvB,IAAI,GAAG,EAAE;oCACP,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;oCAC/B,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,OAAO,EAAE,EAAE,GAAG,EAAE,GAAG,CAAC,QAAQ,EAAE,EAAG,KAAK,EAAE,IAAI,EAAE,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;iCACzF;qCAAM;oCACL,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,OAAO,EAAE,EAAE,GAAG,EAAE,IAAI,EAAG,KAAK,EAAE,KAAK,EAAE,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;iCAChF;4BACH,CAAC,CAAC,CAAC;yBACJ;6BAAM;4BACL,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;4BACzC,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,OAAO,EAAE,EAAE,GAAG,EAAE,+BAA+B,EAAG,KAAK,EAAE,IAAI,EAAE,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;yBACjH;wBACD,MAAM;oBAER,KAAK,kBAAkB;wBAGrB,IAAI,CAAC,GAAG,CAAC,QAAQ;4BAAE,OAAO;wBAE1B,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE;4BAC5B,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,OAAO,EAAE,EAAE,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;4BACrD,OAAO;yBACR;wBACD,MAAM,OAAO,GAAG,IAAI,CAAC,kBAAkB,CAAC,mBAAmB,EAAE,CAAC;wBAC9D,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,OAAO,EAAE,OAAO,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;wBAE1D,MAAM;oBAER,KAAK,QAAQ;wBAGX,IAAI,CAAC,GAAG,CAAC,QAAQ;4BAAE,OAAO;wBAE1B,MAAM,OAAO,GAAqB,EAAE,CAAC;wBACrC,IAAI,GAAG,GAAiB,IAAI,CAAC;wBAG7B,IAAI;4BACF,MAAM,KAAK,GAAG,MAAM,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC;4BAEvD,MAAM,KAAK,GAAsB,EAAE,CAAC;4BACpC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;gCACrC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,oBAAoB,CAAC,EAAE;oCACzC,SAAS;iCACV;gCACD,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,WAAW,IAAI,CAAC,MAAM,CAAC,aAAa,IAAI,KAAK,CAAC,CAAC,CAAC,mBAAmB,CAAC,CAAC;gCACpF,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,aAAa,IAAI,KAAK,CAAC,CAAC,CAAC,mBAAmB,EAAE,MAAM,CAAC,CAAC,CAAC;6BAC3F;4BAED,MAAM,YAAY,GAAqB,CAAC,MAAM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,MAAM,CAAW,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;gCAC9F,GAAG,CAAC,IAAI,CAAC,GAAG,GAAG,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;gCACpC,OAAO,GAAG,CAAC;4BACb,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,cAAc,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;4BAE9D,OAAO,CAAC,IAAI,CAAC,GAAG,YAAY,CAAC,CAAC;yBAE/B;wBAAC,OAAO,EAAO,EAAE;4BAChB,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,4CAA4C,EAAE,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;4BAC3E,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE;gCAC9B,GAAG,GAAG,EAAE,CAAC;6BACV;yBACF;wBAGD,IAAI,IAAI,CAAC,MAAM,CAAC,aAAa,IAAI,IAAI,CAAC,kBAAkB,EAAE;4BACxD,IAAI;gCACF,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,MAAM,EAAE,CAAC;gCAC7D,OAAO,CAAC,IAAI,CAAC,GAAG,aAAa,CAAC,CAAC;6BAChC;4BAAC,OAAO,EAAO,EAAE;gCAChB,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,6CAA6C,EAAE,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;6BAC7E;yBACF;wBAED,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,kBAAkB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;wBAC5D,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC,OAAO,EAAE,EAAE,GAAG,EAAE,OAAO,EAAE,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;wBAEnE,MAAM;iBACT;aACF;QACH,CAAC;KAAA;CAEF;AAhXC;IADC,0BAAQ;6CAyFR;AAMD;IADC,0BAAQ;8CAmBR;AAQD;IADC,0BAAQ;uDAkBR;AAQD;IADC,0BAAQ;uDAGR;AAUD;IADC,0BAAQ;mEAKR;AA6ED;IADC,0BAAQ;mDAqBR;AAOD;IADC,0BAAQ;+CAsGR;AA9YH,wCAgZC;AAED,IAAI,MAAM,CAAC,MAAM,EAAE;IAEjB,MAAM,CAAC,OAAO,GAAG,CAAC,OAAkD,EAAE,EAAE,CAAC,IAAI,cAAc,CAAC,OAAO,CAAC,CAAC;CACtG;KAAM;IAEL,CAAC,GAAG,EAAE,CAAC,IAAI,cAAc,EAAE,CAAC,EAAE,CAAC;CAChC","sourcesContent":["/**\n * ioBroker DS18B20 1-wire temperature sensor adapter.\n *\n * (C) 2019 Peter Müller <peter@crycode.de> (https://github.com/crycode-de/ioBroker.ds18b20)\n */\n\nimport { promisify } from 'util';\n\nimport * as fs from 'fs';\nconst readFile = promisify(fs.readFile);\nconst readDir = promisify(fs.readdir);\n\nimport * as crypto from 'crypto';\n\nimport * as utils from '@iobroker/adapter-core';\n\nimport { autobind } from 'core-decorators';\n\nimport { Sensor } from './sensor';\n\nimport { RemoteSensorServer } from './remote-server';\n\ndeclare global {\n  // eslint-disable-next-line @typescript-eslint/no-namespace\n  namespace ioBroker {\n    interface AdapterConfig {\n      defaultInterval: number;\n      remoteEnabled: boolean;\n      remoteKey: string;\n      remotePort: number;\n      w1DevicesPath: string;\n    }\n  }\n}\n\n/**\n * The ds18b20 adapter.\n */\nexport class Ds18b20Adapter extends utils.Adapter {\n\n  /**\n   * Mapping of the ioBroker object IDs to the sensor class instances.\n   */\n  private sensors: Record<string, Sensor> = {};\n\n  /**\n   * The server for remote sensors if enabled.\n   */\n  public remoteSensorServer: RemoteSensorServer | null = null;\n\n  /**\n   * Constructor to create a new instance of the adapter.\n   * @param options The adapter options.\n   */\n  public constructor(options: Partial<utils.AdapterOptions> = {}) {\n    super({\n      ...options,\n      name: 'ds18b20',\n    });\n\n    this.on('ready', this.onReady);\n    this.on('stateChange', this.onStateChange);\n    this.on('message', this.onMessage);\n    this.on('unload', this.onUnload);\n  }\n\n  /**\n   * Is called when databases are connected and adapter received configuration.\n   */\n  @autobind\n  private async onReady(): Promise<void> {\n    // Reset the connection indicator during startup\n    this.setState('info.connection', false, true);\n\n    // set default devices path if not defined\n    if (!this.config.w1DevicesPath) {\n      this.config.w1DevicesPath = '/sys/bus/w1/devices';\n    }\n\n    // remote sensor server\n    if (this.config.remoteEnabled) {\n      // check decrypt native support and show a warning in case of unsupported\n      if (this.supportsFeature && !this.supportsFeature('ADAPTER_AUTO_DECRYPT_NATIVE')) {\n        this.log.warn('The server for remote sensors is enabled but decrypt native is not supported! The encryption key will be stored unencrypted in the ioBroker database. To get decrypt native support, please upgrade js-controller to v3.0 or greater.');\n      }\n\n      // check the port\n      if (!this.config.remotePort || this.config.remotePort <= 0) {\n        this.log.warn('Config: Invalid port for the remote sensor server! Using default port 1820.');\n        this.config.remotePort = 1820;\n      }\n\n      // check the key\n      if (typeof this.config.remoteKey !== 'string' || this.config.remoteKey.length !== 64) {\n        this.config.remoteKey = crypto.randomBytes(32).toString('hex');\n        this.log.error(`Config: Invalid key for the remote sensor server! Using random key \"${this.config.remoteKey}\".`);\n      }\n\n      this.remoteSensorServer = new RemoteSensorServer(this.config.remotePort, this.config.remoteKey, this);\n\n      this.remoteSensorServer.on('listening', () => {\n        this.log.info(`Remote sensor server is listening on port ${this.config.remotePort}`);\n        this.updateInfoConnection();\n      });\n\n      this.remoteSensorServer.on('error', (err: Error) => {\n        this.log.warn(`Remote sensor server error: ${err.toString()}`);\n        this.log.debug(`${err.toString()} ${err.stack}`);\n        this.updateInfoConnection();\n      });\n    }\n\n    // setup sensors\n    this.getForeignObjects(this.namespace + '.sensors.*', 'state', (err, objects) => {\n      if (err) {\n        this.log.error('error loading sensors data objects');\n        return;\n      }\n\n      for (const objectId in objects) {\n        const obj: SensorObject = objects[objectId] as SensorObject;\n\n        if (typeof obj.native.address !== 'string') {\n          this.log.warn(`Object ${obj._id} has no valid address!`);\n          continue;\n        }\n\n        if (obj.native.enabled === false) {\n          this.log.debug(`Sensor ${obj.native.address} is not enabled and will be ignored.`);\n          continue;\n        }\n\n        if (obj.native.remoteSystemId && !this.config.remoteEnabled) {\n          this.log.warn(`Sensor ${obj.native.address} is configured as remote sensor of ${obj.native.remoteSystemId} but remote sensors are not enabled!`);\n          continue;\n        }\n\n        this.sensors[obj._id] = new Sensor({\n          w1DevicesPath: this.config.w1DevicesPath,\n          id: obj._id,\n          address: obj.native.address,\n          interval: typeof obj.native.interval === 'number' ? obj.native.interval : this.config.defaultInterval,\n          nullOnError: !!obj.native.nullOnError,\n          factor: typeof obj.native.factor === 'number' ? obj.native.factor : 1,\n          offset: typeof obj.native.offset === 'number' ? obj.native.offset : 0,\n          decimals: typeof obj.native.decimals === 'number' ? obj.native.decimals : null,\n          remoteSystemId: typeof obj.native.remoteSystemId === 'string' ? obj.native.remoteSystemId : null,\n        }, this);\n        this.sensors[obj._id].on('value', this.handleSensorValue);\n        this.sensors[obj._id].on('error', this.handleSensorError);\n        this.sensors[obj._id].on('errorStateChanged', this.handleSensorErrorStateChanged);\n      }\n\n      this.log.debug(`loaded ${Object.keys(this.sensors).length} sensors`);\n    });\n\n    // subscribe needed states\n    this.subscribeStates('actions.*');\n  }\n\n  /**\n   * Is called when adapter shuts down - callback has to be called under any circumstances!\n   */\n  @autobind\n  private async onUnload(callback: () => void): Promise<void> {\n    try {\n      // stop all intervals from the sensors\n      for (const address in this.sensors) {\n        this.sensors[address].stop();\n      }\n\n      // stop the remote sensor server\n      if (this.remoteSensorServer) {\n        await this.remoteSensorServer.stop();\n      }\n\n      // reset connection state\n      await this.setStateAsync('info.connection', false, true);\n\n    } catch(e) { }\n\n    callback();\n  }\n\n  /**\n   * Handler for incoming sensor values.\n   * @param value The value or null in case of an error.\n   * @param id    The ioBroker ID of the sensor.\n   */\n  @autobind\n  private handleSensorValue (value: number | null, id: string): void {\n    if (!this.sensors[id]) return;\n\n    this.log.debug(`got value ${value} from sensor ${this.sensors[id].address}`);\n\n    if (value === null) {\n      this.setStateAsync(id, {\n        ack: true,\n        val: null,\n        q: 0x81, // general problem by sensor\n      });\n    } else {\n      this.setStateAsync(id, {\n        ack: true,\n        val: value,\n      });\n    }\n  }\n\n  /**\n   * Handler for sensor errors.\n   * @param err The error.\n   * @param id  The ioBroker ID of the sensor.\n   */\n  @autobind\n  private handleSensorError (err: Error, id: string): void {\n    this.log.warn(`Error reading sensor ${this.sensors[id].address}: ${err}`);\n  }\n\n  /**\n   * Handler for changes of error state of a sensor.\n   * This will change the info.connection state of the adapter to true if all\n   * sensors are ok and false if at least one sensor has an error.\n   * @param hasError Indicator if the sensor has an error or not.\n   * @param id       The ioBroker ID of the sensor.\n   */\n  @autobind\n  private handleSensorErrorStateChanged (hasError: boolean, id: string): void {\n    this.log.debug(`error state of sensor ${this.sensors[id].address} changed to ${hasError}`);\n\n    this.updateInfoConnection();\n  }\n\n  /**\n   * Update the info.connection state depending on the error state of all\n   * sensors and the listening state of the remote sensor server.\n   */\n  private updateInfoConnection (): void {\n    // check if remote sensor server is listening if enabled\n    if (this.remoteSensorServer && !this.remoteSensorServer.isListening()) {\n      // server enabled but not listening\n      this.setStateAsync('info.connection', false, true);\n      return;\n    }\n\n    // check all sensors for errors\n    for (const id in this.sensors) {\n      if (this.sensors[id].hasError) {\n        // at least one sensor has an error, set connection state to false\n        this.setStateAsync('info.connection', false, true);\n        return;\n      }\n    }\n\n    // all sensors are ok, set connection state to true\n    this.setStateAsync('info.connection', true, true);\n  }\n\n  /**\n   * Get a defined sensor from it's ioBroker ID or 1-wire address.\n   * @param  idOrAddress The ID or address of the sensor.\n   * @return             The sensor or null.\n   */\n  public getSensor (idOrAddress: string): Sensor | null {\n    if (this.sensors[idOrAddress]) return this.sensors[idOrAddress];\n\n    // check address\n    for (const id in this.sensors) {\n      if (this.sensors[id].address === idOrAddress) {\n        return this.sensors[id];\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Trigger the reading of a single sensor or all sensors.\n   * @param idOrAddress The ioBroker ID or 1-wire address of the sensor. Use `all` or an empty string to read all sensors.\n   */\n  private readNow (idOrAddress?: string): void {\n    if (typeof idOrAddress !== 'string' || idOrAddress === 'all' || idOrAddress === '') {\n      // read all sensors\n      this.log.info(`Read data from all sensors now`);\n      for (const addr in this.sensors) {\n        this.sensors[addr].read();\n      }\n\n    } else {\n      // read a specific sensor\n      const sens = this.getSensor(idOrAddress);\n\n      if (!sens) {\n        this.log.warn(`No sensor with address or id ${idOrAddress} found!`);\n        return;\n      }\n\n      this.log.info(`Read data from sensor ${sens.address} now`);\n      sens.read();\n    }\n  }\n\n  /**\n   * Is called if a subscribed state changes.\n   * @param id    The ID of the state.\n   * @param state The ioBroker state.\n   */\n  @autobind\n  private async onStateChange(id: string, state: ioBroker.State | null | undefined): Promise<void> {\n    if (state) {\n      // The state was changed\n      this.log.debug(`state ${id} changed: ${state.val} (ack = ${state.ack}) ` + JSON.stringify(state));\n\n      // don't do anything if ack is set\n      if (state.ack === true) return;\n\n      // handle special states\n      switch (id) {\n        case this.namespace + '.actions.readNow':\n          this.readNow(state.val as string);\n          this.setStateAsync(this.namespace + '.actions.readNow', '', true);\n          break;\n      }\n\n    } else {\n      // The state was deleted\n      this.log.debug(`state ${id} deleted`);\n    }\n  }\n\n  /**\n   * Some message was sent to this instance over message box (e.g. by a script).\n   * @param obj The received ioBroker message.\n   */\n  @autobind\n  private async onMessage(obj: ioBroker.Message): Promise<void> {\n    this.log.debug('got message ' + JSON.stringify(obj));\n\n    if (typeof obj === 'object' && obj.message) {\n      switch (obj.command) {\n        case 'readNow':\n          // we should read sensors now...\n          if (typeof obj.message === 'string') {\n            this.readNow(obj.message);\n          } else {\n            this.readNow();\n          }\n          break;\n\n        case 'read':\n          // read a sensor\n          if (typeof obj.message === 'string') {\n            const sens = this.getSensor(obj.message);\n            if (!sens) {\n              this.log.debug('no such sensor');\n              return this.sendTo(obj.from, obj.command, { err: 'No such sensor' , value: null }, obj.callback);\n            }\n            sens.read((err, value) => {\n              if (err) {\n                this.log.debug(err.toString());\n                this.sendTo(obj.from, obj.command, { err: err.toString() , value: null }, obj.callback);\n              } else {\n                this.sendTo(obj.from, obj.command, { err: null , value: value }, obj.callback);\n              }\n            });\n          } else {\n            this.log.debug('no address or id given');\n            return this.sendTo(obj.from, obj.command, { err: 'No sensor address or id given' , value: null }, obj.callback);\n          }\n          break;\n\n        case 'getRemoteSystems':\n          // get connected remote systems\n          // don't do anything if no callback is provided\n          if (!obj.callback) return;\n\n          if (!this.remoteSensorServer) {\n            this.sendTo(obj.from, obj.command, [], obj.callback);\n            return;\n          }\n          const systems = this.remoteSensorServer.getConnectedSystems();\n          this.sendTo(obj.from, obj.command, systems, obj.callback);\n\n          break;\n\n        case 'search':\n          // search for sensors\n          // don't do anything if no callback is provided\n          if (!obj.callback) return;\n\n          const sensors: SearchedSensor[] = [];\n          let err: Error | null = null;\n\n          // local sensors\n          try {\n            const files = await readDir(this.config.w1DevicesPath);\n\n            const proms: Promise<string>[] = [];\n            for (let i = 0; i < files.length; i++) {\n              if (!files[i].match(/^w1_bus_master\\d+$/)) {\n                continue;\n              }\n              this.log.debug(`reading ${this.config.w1DevicesPath}/${files[i]}/w1_master_slaves`);\n              proms.push(readFile(`${this.config.w1DevicesPath}/${files[i]}/w1_master_slaves`, 'utf8'));\n            }\n\n            const localSensors: SearchedSensor[] = (await Promise.all(proms)).reduce<string[]>((acc, cur) => {\n              acc.push(...cur.trim().split('\\n'));\n              return acc;\n            }, []).map((addr) => ({ address: addr, remoteSystemId: '' }));\n\n            sensors.push(...localSensors);\n\n          } catch (er: any) {\n            this.log.warn(`Error while searching for local sensors: ${er.toString()}`);\n            if (!this.config.remoteEnabled) {\n              err = er;\n            }\n          }\n\n          // remote sensors\n          if (this.config.remoteEnabled && this.remoteSensorServer) {\n            try {\n              const remoteSensors = await this.remoteSensorServer.search();\n              sensors.push(...remoteSensors);\n            } catch (er: any) {\n              this.log.warn(`Error while searching for remote sensors: ${er.toString()}`);\n            }\n          }\n\n          this.log.debug(`sensors found: ${JSON.stringify(sensors)}`);\n          this.sendTo(obj.from, obj.command, { err, sensors }, obj.callback);\n\n          break;\n      }\n    }\n  }\n\n}\n\nif (module.parent) {\n  // Export the constructor in compact mode\n  module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Ds18b20Adapter(options);\n} else {\n  // otherwise start the instance directly\n  (() => new Ds18b20Adapter())();\n}\n"]}